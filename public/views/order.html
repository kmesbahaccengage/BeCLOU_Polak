<html lang="en" dir="ltr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>BeClou</title>
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css" integrity="sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/grids-responsive-min.css">

    <link rel="stylesheet" type="text/css" href="/stylesheets/styleresa.css">
    <link rel="stylesheet" href="../stylesheets/burger.css">
    <link rel="stylesheet" href="../stylesheets/grid.css">
    <link rel="stylesheet" href="../stylesheets/fonts.css">
    <link rel="stylesheet" href="../stylesheets/media-queries.css">

    <link href="https://fonts.googleapis.com/css?family=Poppins" rel="stylesheet">
</head>
<body>
    <div id="menu_resp" class="pure-g">
        <div class="pure-u-1-3">

        </div>
        <div class="pure-u-1-3" id="logoContainer"><p></p></div>

        <div class="pure-u-1-3">
        </div>
      </div>
      <div id="menu_resp2" class="pure-g">
        <div class="pure-u-1-3">

    </div>
        <div class="pure-u-1-3" id="logoContainer" onclick="location.href='/';" style="cursor:pointer;"><p></p></div>

        <div class="pure-u-1-3">
        </div>
      </div>
<section>
    <div class="info_content" id="resa">
        <div class="title explain">
          <h1>Reservation</h1>
          <p>Your history.</p>
        </div>
        <div class="current">
          <h2>My current reservation</h2>
          <div class="current_resa" id="current_resa">

          </div>
        </div>
        <div class="last_resa">
          <h2>My previous reservation</h2>
          <div class="histo_resa" id="histo_resa">

          </div>
        </div>
    </div>
      <div class="data_info" id="info_reservation">

      </div>
</section>
<script>
    getReservations();

    function cleanDate(date){
        date = date.replace('T', ' ');
        date = date.slice(0, 10);
        return date;
    }

    function getReservationTemplate(date, prix, current){
        if (current === "yes"){
            return `<div><p>${date}</p><p>${prix} €</p><button onclick="cancelReservation()">Cancel</button></div>`
        } else return `<div><p>${date}</p><p>${prix} €</p></div>`
    }

    async function getUserIdBySession() {
        let url = '/api/users/session';
        let userId;
        let result = await fetch(url,
            {
                method: 'GET'
            });
        if (result.status === 200) {
            userId = await result.json();
            return userId.id;
        } else return null;
    }

    async function getReservations() {
        let userId = await getUserIdBySession();
        let url = '/api/reservations/all?user_id=' + userId;
        let result = await fetch(url, {
            method: 'GET'
        });
        reservations = await result.json();
        let currentReservation;
        let previousReservations = [];
        for (let i = 0; i < reservations.length; i++){
            if (reservations[i].status < 3){
                currentReservation = reservations[i];
            } else previousReservations.push(reservations[i]);
        }
        document.getElementById("current_resa").innerHTML = getReservationTemplate(cleanDate(currentReservation.begin_at), currentReservation.duration, "yes");
        for (let i = 0; i < previousReservations.length; i++){
            document.getElementById("histo_resa").innerHTML = getReservationTemplate(cleanDate(previousReservations[i].begin_at), currentReservation.duration, "no");
        }
    }
</script>
</body>
</html>
